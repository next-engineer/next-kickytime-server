name: ECS - Deploy

on:
  workflow_run:
    workflows: ["ECR - Build & Push"]  # â† ECR ì›Œí¬í”Œë¡œìš° 'name' ì •í™•ížˆ ìž…ë ¥
    types: [completed]
  workflow_dispatch:

concurrency:
  group: ecs-main
  cancel-in-progress: false

permissions:
  contents: read

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: kickytime-repo        # ECR ë¦¬í¬ ì´ë¦„
  ECS_CLUSTER: kickytime-cluster        # ECS í´ëŸ¬ìŠ¤í„° ì´ë¦„
  ECS_SERVICE: kickytime-task-service   # ECS ì„œë¹„ìŠ¤ ì´ë¦„
  TASK_FAMILY: kickytime-task           # íƒœìŠ¤í¬ ì •ì˜ íŒ¨ë°€ë¦¬
  CONTAINER_NAME: kickytime-ecr         # TD ì•ˆ ì»¨í…Œì´ë„ˆ ì´ë¦„(ì •í™•ížˆ ì¼ì¹˜)

jobs:
  deploy:
    # ECR ì›Œí¬í”Œë¡œìš°ê°€ 'ì„±ê³µ'ì´ê³ , ëŒ€ìƒ ë¸Œëžœì¹˜ê°€ mainì¼ ë•Œë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'develop' }}
    runs-on: ubuntu-latest
    env:
      HEAD_SHA: ${{ github.event.workflow_run.head_sha }}

    steps:
      - name: Checkout same commit (from ECR build)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.HEAD_SHA }}

      - name: Configure AWS credentials (Access Keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # ECRì—ì„œ ì‚¬ìš©í•œ ê²ƒê³¼ ë™ì¼í•œ íƒœê·¸(HEAD_SHA 12ìžë¦¬)ë¡œ ì´ë¯¸ì§€ URIë¥¼ ìž¬êµ¬ì„±
      - name: Compute IMAGE_URI (same tag as ECR)
        id: tag
        run: |
          TAG=${HEAD_SHA::12}
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "IMAGE_URI=${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${TAG}" >> $GITHUB_OUTPUT

      - name: Describe current Task Definition
        run: |
          aws ecs describe-task-definition \
            --task-definition "${{ env.TASK_FAMILY }}" \
            --query 'taskDefinition' > td.json

      # ðŸ”¥ ARM64 ì•„í‚¤í…ì²˜ ëª…ì‹œì  ì„¤ì • ì¶”ê°€
      - name: Patch image & ensure ARM64 platform (keep env/secrets)
        run: |
          jq --arg NAME "${{ env.CONTAINER_NAME }}" --arg IMG "${{ steps.tag.outputs.IMAGE_URI }}" '
            .containerDefinitions |= map(if .name == $NAME then .image = $IMG else . end)
            | .runtimePlatform = {
                "cpuArchitecture": "ARM64",
                "operatingSystemFamily": "LINUX"
              }
            | del(.taskDefinitionArn,.revision,.status,.requiresAttributes,.compatibilities,.registeredAt,.registeredBy)
          ' td.json > td-new.json

      # ë””ë²„ê¹…: íƒœìŠ¤í¬ ì •ì˜ ë‚´ìš© í™•ì¸
      - name: Verify Task Definition content
        run: |
          echo "=== Task Definition Platform & Container Info ==="
          jq '.runtimePlatform' td-new.json
          jq '.containerDefinitions[] | {name: .name, image: .image, cpu: .cpu, memory: .memory}' td-new.json

      - name: Register new Task Definition
        id: register
        run: |
          NEW_TD_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://td-new.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "TASK_DEF_ARN=$NEW_TD_ARN" >> $GITHUB_OUTPUT
          echo "New TD (ARM64): $NEW_TD_ARN"

      - name: Update service (rolling deployment)
        run: |
          aws ecs update-service \
            --cluster "${{ env.ECS_CLUSTER }}" \
            --service "${{ env.ECS_SERVICE }}" \
            --task-definition "${{ steps.register.outputs.TASK_DEF_ARN }}" \
            --force-new-deployment

      # ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° ì‹œê°„ì„ ì¤„ì´ê³  ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
      - name: Wait for deployment (with timeout)
        id: wait_deploy
        continue-on-error: true
        run: |
          timeout 600 aws ecs wait services-stable \
            --cluster "${{ env.ECS_CLUSTER }}" \
            --services "${{ env.ECS_SERVICE }}" || echo "WAIT_FAILED=true" >> $GITHUB_OUTPUT

      # ë°°í¬ ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
      - name: Debug failed deployment
        if: steps.wait_deploy.outputs.WAIT_FAILED == 'true'
        run: |
          echo "ðŸ” Deployment failed, collecting debug info..."
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "=== Service Description ==="
          aws ecs describe-services \
            --cluster "${{ env.ECS_CLUSTER }}" \
            --services "${{ env.ECS_SERVICE }}"
          
          # ìµœê·¼ íƒœìŠ¤í¬ë“¤ ìƒíƒœ í™•ì¸
          echo "=== Recent Tasks ==="
          aws ecs list-tasks \
            --cluster "${{ env.ECS_CLUSTER }}" \
            --service-name "${{ env.ECS_SERVICE }}" \
            --max-items 5 \
            --query 'taskArns[]' --output text | \
          xargs -I {} aws ecs describe-tasks \
            --cluster "${{ env.ECS_CLUSTER }}" \
            --tasks {} \
            --query 'tasks[0].{TaskArn:taskArn,LastStatus:lastStatus,HealthStatus:healthStatus,StoppedReason:stoppedReason,Platform:runtimePlatform}'
          
          # ì„œë¹„ìŠ¤ ì´ë²¤íŠ¸ í™•ì¸
          echo "=== Service Events ==="
          aws ecs describe-services \
            --cluster "${{ env.ECS_CLUSTER }}" \
            --services "${{ env.ECS_SERVICE }}" \
            --query 'services[0].events[:10]'

      - name: Check task definition details
        if: steps.wait_deploy.outputs.WAIT_FAILED == 'true'
        run: |
          echo "=== Task Definition Details ==="
          aws ecs describe-task-definition \
            --task-definition "${{ steps.register.outputs.TASK_DEF_ARN }}" \
            --query 'taskDefinition.{
              Family: family,
              Revision: revision,
              Cpu: cpu,
              Memory: memory,
              Platform: runtimePlatform,
              Containers: containerDefinitions[].{
                Name: name,
                Image: image,
                Cpu: cpu,
                Memory: memory,
                Essential: essential,
                PortMappings: portMappings,
                HealthCheck: healthCheck
              }
            }'

      - name: Rollback on failure
        if: steps.wait_deploy.outputs.WAIT_FAILED == 'true'
        run: |
          echo "ðŸ”„ Rolling back to previous task definition..."
          
          # ì´ì „ íƒœìŠ¤í¬ ì •ì˜ ì°¾ê¸°
          PREV_TD=$(aws ecs describe-services \
            --cluster "${{ env.ECS_CLUSTER }}" \
            --services "${{ env.ECS_SERVICE }}" \
            --query 'services[0].taskDefinition' \
            --output text)
          
          echo "Rolling back to: $PREV_TD"
          
          aws ecs update-service \
            --cluster "${{ env.ECS_CLUSTER }}" \
            --service "${{ env.ECS_SERVICE }}" \
            --task-definition "$PREV_TD"

      - name: Final status and summary
        run: |
          if [ "${{ steps.wait_deploy.outputs.WAIT_FAILED }}" == "true" ]; then
            echo "### âŒ ECS Deploy Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check the debug output above for details." >> $GITHUB_STEP_SUMMARY
            echo "- Issue: Likely ARM64 architecture mismatch" >> $GITHUB_STEP_SUMMARY
            echo "- Next step: Verify ECR build uses ARM64 platform" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### âœ… ECS Deploy Completed (ARM64)" >> $GITHUB_STEP_SUMMARY
            echo "- Cluster: \`${{ env.ECS_CLUSTER }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Service: \`${{ env.ECS_SERVICE }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- TD: \`${{ steps.register.outputs.TASK_DEF_ARN }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Image: \`${{ steps.tag.outputs.IMAGE_URI }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Platform: \`ARM64/LINUX\`" >> $GITHUB_STEP_SUMMARY
          fi